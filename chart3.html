<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="libs/queue/queue.v1.min.js"></script>
    <script src="libs/topojson/topojson.v1.min.js"></script>

<style>
body { 
    font: 10px sans-serif; 
} 
.axis text {
    font: 10px sans-serif;
}

.axis line,
.axis path {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}
#monthWaterVis{

    float:left;
}
#waterVis{

    float:left;
}
#bayVis{

    float:left;
}
#oysterVis{

    float:left;
}
.line {
  fill: none;
  stroke: blue;
  stroke-width: 1.5px;
}

</style>

</head>
<body>
    <div><text id="selectedYear"></text>
    <div>
        <label><input class="measure" type="radio" name="measure" value="tn" checked>Nitrogen</label>
        <label><input class="measure" type="radio" name="measure" value="tp" >Phosphorous</label>
        <label><input class="measure" type="radio" name="measure" value="do" >Dissolved Oxygen</label>
        <label><input class="measure" type="radio" name="measure" value="salinity" >Salinity</label>
        <label><input class="measure" type="radio" name="measure" value="wtemp" >Water Temp</label>

    </div>
    <div id="monthWaterVis"></div>
    <div width=600 id="bayVis"></div>
    <div width=400 id="oysterVis"></div>
    <div id="waterVis"></div>
    <script>

        $(function(){

            var waterQualityData = [];
            var stationInfoData = [];
            var landingsData = [];
            var chesapeake;
            var selectedYear = 1995;  //year selected by user - will make this interactive

            var initVis = function(){

                var EventHandler = new Object();

                d3.select("#selectedYear").text("Chesapeake Bay Water Quality - " + selectedYear).style("font-size", "18px");
                drawMonthWater();
                drawCoast();
                drawOyster();
                drawWater();
            } 

            function drawCoast() {

                var margin = {top:20, right:20, bottom:30, left:80};
                var width = 310 - margin.left - margin.right;
                var height = 700 - margin.top - margin.bottom;
                var padding = 10;

                var svg = d3.select("#bayVis").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);

                var projection = d3.geo.mercator().scale(10000)//scale(15000)
                    .center([-74.6,38.5]);//.center([-75.5,39]);

                var path = d3.geo.path()
                    .projection(projection);

                var topo = topojson.feature(chesapeake, chesapeake.objects.shore_dd);
               // console.log(topo.features);

                svg.selectAll("path")
                    .data(topo.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", "lightblue");
       
 //           projection.scale(1);

                var yScale = d3.scale.linear()
                    .domain([d3.min(stationInfoData, function(d) { return d.lat; }), d3.max(stationInfoData, function(d) { return d.lat; })])
                    .range([595, 15]);

                var xScale = d3.scale.linear()
                    .domain([d3.max(stationInfoData, function(d) { return d.lon; }), d3.min(stationInfoData, function(d) { return d.lon; })])
                    .range([145, 245]);

                var node = svg.selectAll(".station")
                    .data(stationInfoData)
                    .enter()
                    .append("g").attr("class", "station");
        
                var circle = node.append("circle")
                    .attr("r", 5)
                    .style("cursor", "pointer")
                    .style("stroke", "white")
//                    .style("fill", "black")
                    .style("opacity", 0.8)
                    .append("svg:title")
                        .text(function(d) { return "lat:" + d.lat + ", lon:" + d.lon;});
        
                var stationid = node.append("text")
                    .text(function(d) {return d.station;})
                    .attr("x", function() {return 8;})
                    .attr("y", function() {return 3;})
                    .attr("transform", function() {
                        return "rotate(-15)" 
                    })
                    .style("opacity", 0);

                node
                    .on("mouseover", function(d) {
                            d3.select(this).attr("fill", "red");
                            stationid.style("opacity", function(k) {if (k.station == d.station) {return 1;} else { return 0;}});
                        })
                    .on("mouseout", function() {
                        stationid.style("opacity", 0);
                        d3.select(this).attr("fill", "black");
                    })
                    .on("click", function(d) { 
                        alert("clicking here will display graph for " + d.station);
 //                       stationid.style("opacity", 0);
 //                       stationid.style("opacity", function(k) {if (k.station == d.station) {return 1;} else { return 0;}});
                    })

                node.transition().duration(500)
                    .attr("transform", function(d) { 
                        return "translate("+xScale(d.lon)+","+yScale(d.lat)+")"; 
                    });
            }

            function drawOyster() {

                var oystermd = landingsData.filter(function(d) { return d.species == "Oyster" && d.state == "Maryland";});

                var margin = {top:20, right:20, bottom:30, left:80};
                var width = 450 - margin.left - margin.right;
                var height = 250 - margin.top - margin.bottom;
                var padding = 10;

                var xScale = d3.scale.linear().range([0, width])
                    .domain([1929, 2013]);
                var yScale = d3.scale.linear()
                    .range([height, 10])
                    .domain([0, d3.max(oystermd, function(d) { return d.pounds; })]);

                var svg = d3.select("#oysterVis").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                svg.append("text").text("Oyster Landings by Year").attr("x", 100).attr("y", 0).style("font", "12px sans-serif");
/*
                var point = svg.selectAll(".point")
                    .data(oystermd)
                    .enter()
                    .append("g").attr("class", "point");     */

                var line = d3.svg.line()
                    .x(function(d) { return xScale(d.year); })
                    .y(function(d) { return yScale(d.pounds); });
        
                var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .tickFormat(d3.format("d"));

                var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left");  

/*                var sizescale = d3.scale.linear().range([2,20])
                    .domain([d3.min(oystermd, function(d) {return d.value;}), d3.max(oystermd, function(d) {return d.value;})]);

                point.append("circle")
                    .style("fill", function(d) { if (d.species == "Oyster") {return "blue";} else {return "red";}})
                    .style("opacity", .8)
                    .attr("cx", function(d){return xScale(d.year);})
                    .attr("cy", function(d) {return yScale(d.pounds);})
                    .attr("r", 4)//function(d) {return sizescale(d.value);})
                    .append("svg:title")
                        .text(function(d){ return "year " + d.year + " pounds " + d.pounds + " value " + d.value + " state " + d.state + " species " + d.species;});   */
         
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .attr("id", "yaxis")
                    .call(yAxis);

                svg.append("path")
                    .datum(oystermd)
                    .attr("class", "line")
                    .attr("d", line);

                svg.append("line")
                    .attr("x1", xScale(selectedYear))  
                    .attr("y1", 0)
                    .attr("x2", xScale(selectedYear))  
                    .attr("y2", height)
                    .style("stroke-width", 1)
                    .style("stroke", "red")
                    .style("fill", "none");

            }

            function drawWater() {
                var measure = "TN";
                var layer = "B ";
                var station = "CB3.1";

                var water = waterQualityData.filter(function(d) { return d.station == station && d.mlayer == layer && d.parameter == measure;});

                var margin = {top:20, right:20, bottom:30, left:80};
                var width = 450 - margin.left - margin.right;
                var height = 250 - margin.top - margin.bottom;
                var padding = 10;

                var xScale = d3.scale.linear().range([0, width])
                    .domain([1, 12]);
                var yScale = d3.scale.linear()
                    .range([height, 10])
                    .domain([0, d3.max(water, function(d) { return d.mvalue; })]);

                var svg = d3.select("#waterVis").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                svg.append("text").text("Nitrogen for station " + station).attr("x", 100).attr("y", 0).style("font", "12px sans-serif");

                var point = svg.selectAll(".point")
                    .data(water)
                    .enter()
                    .append("g").attr("class", "point");
           
                var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .tickFormat(d3.format("d"));

                var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left");  

                point.append("circle")
                    .style("fill", "blue")
                    .style("opacity", .8)
                    .attr("cx", function(d){return xScale(d.month);})
                    .attr("cy", function(d) {return yScale(d.mvalue);})
                    .attr("r", 4);
         
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .attr("id", "yaxis")
                    .call(yAxis);                
            }

            function drawMonthWater() {
                var layer = "B ";
                var measure = "TN";
                var water_year = waterQualityData.filter(function(d) { return d.mlayer == layer && d.parameter == measure;});
//console.log(water_year);
//                console.log(water_year);
                //Aggregate water quality data by year to draw first graph
                var waterYear = d3.nest()
                    .key(function(d) {return d.month;})
                    .rollup(function(d) {return [
                        d3.mean(d, function(d) {return parseFloat(d.mvalue);})
                    ]})
                    .entries(water_year);
 
                waterYear = waterYear.map(function(d) {
                    var res = {
                        year: 2014,
                        month: d.key,
                        mvalue: d.values[0]
                    }
                    return res;
                });

console.log(waterYear);

                var margin = {top:20, right:20, bottom:30, left:80};
                var width = 450 - margin.left - margin.right;
                var height = 250 - margin.top - margin.bottom;
                var padding = 10;

                var xScale = d3.scale.linear().range([0, width])
                    .domain([1, 12]);
                var yScale = d3.scale.linear()
                    .range([height, 10])
                    .domain([0, d3.max(waterYear, function(d) { return d.mvalue; })]);

                var svg = d3.select("#monthWaterVis").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                svg.append("text").text("Monthly Nitrogen Averages").attr("x", 100).attr("y", 0).style("font", "12px sans-serif");

                var point = svg.selectAll(".point")
                    .data(waterYear)
                    .enter()
                    .append("g").attr("class", "point");
           
                var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .tickFormat(d3.format("d"));

                var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left");  

                point.append("circle")
                    .style("fill", "blue")
                    .style("opacity", .8)
                    .attr("cx", function(d){return xScale(d.month);})
                    .attr("cy", function(d) {return yScale(d.mvalue);})
                    .attr("r", 4);
         
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .attr("id", "yaxis")
                    .call(yAxis);     
            }

            var dataLoaded = function (error, _waterQuality, _stationInfo, _landings, _topomap) {

                if (!error) {

                    landingsData = _landings.map(function(d) {
                        var res = {
                            year: parseInt(d.Year),
                            pounds: parseInt(d.Pounds),
                            value: parseInt(d.Value),
                            state: d.State,
                            species: d.Species
                        }

                        return res;

                    });

                    stationInfoData = _stationInfo.map(function(d) {
                        var res = {
                            station: d.Station,
                            description: d.Station_Description,
                            fips: d.FIPS,
                            county: d.County_City,
                            lat: d.Latitude,
                            lon: d.Longitude
                        }

                        return res;
                    });

                    waterQualityData = _waterQuality.map(function(d) {
                        var res = {
                            station: d.Station,
                            month: d.Month,
                            year: d.Year,
                            depth: d.Total_Depth,
                            mlayer: d.Layer,
                            parameter: d.Parameter,
                            mvalue: parseFloat(d.MeasureValue),
                            unit: d.Unit,
                            lat: d.Lat,
                            lon: d.Long
                        }
                        return res;
                    });

                    chesapeake = _topomap;

                    initVis(); 
                }
            }

            var startHere = function(){

                //TODO: load data here and call "dataLoaded" afterwards
                // Hint: http://giscollective.org/d3-queue-js/
                queue()
                    .defer(d3.csv, 'data/waterQuality2014.csv')
                    .defer(d3.csv, 'data/StationInfoRefined.csv')
                    .defer(d3.csv, 'data/OysterCrabLandings.csv')
                    .defer(d3.json, 'data/shapefile/chesapeaketopo4.json')
                    .await(function(error, waterQuality, stationInfo, landings, topomap) {
                        dataLoaded(error, waterQuality, stationInfo, landings, topomap);
                    });
            }

            startHere();
        })
    </script>
</body>
</html>